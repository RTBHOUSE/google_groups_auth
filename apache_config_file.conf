<IfModule mod_ssl.c>
    <VirtualHost _default_:443>

        ServerAdmin webmaster@example.com
        DocumentRoot /var/www/html
        ServerName example.com


        # ------------------------------------------------------------------------
        # Definicja skryptu google_groups_auth
        # ------------------------------------------------------------------------
        RewriteEngine On
        RewriteMap gauthgroup "prg:/opt/apache/google_groups_auth.py"

      <Location ~ "/">
	  
	  AuthType openid-connect
          Require valid-user
          SSLRequireSSL



          ##########################################################################
          ###########  GOOGLE GROUPS AUTHENTICATOR                             START
          ##########################################################################
          # ------------------------------------------------------------------------
          # Czyszcze wazne zmienne aby aby nikt czegos nie dokleil 
          # ------------------------------------------------------------------------

          RequestHeader unset  googlegroups
          RewriteRule .* - [E=ifaccess:no]

          # ------------------------------------------------------------------------
          # Definicja zmiennej opisujacej grupy
          # ------------------------------------------------------------------------

          RewriteRule .* - [E=authgroups:FirstGroup@rtbhouse.com]

          # ------------------------------------------------------------------------
          # GOOGLE GROUPS
          # ------------------------------------------------------------------------

          RewriteRule .* - [E=authgroups:%{ENV:authgroups};SecondGroup@rtbhouse.com]
          RewriteRule .* - [E=authgroups:%{ENV:authgroups};AnotherGroup@rtbhouse.com]
	  #......

          # ------------------------------------------------------------------------
          # Sprawdzenie uprawnien dostepu, ifaccess zawiera odpowiedz yes lub no dotyczaca dostepu
          # ------------------------------------------------------------------------

          RewriteRule .* - [E=ifaccess:${gauthgroup:auth#%{REMOTE_USER}#%{ENV:authgroups}}]
          RewriteCond %{ENV:ifaccess} !^yes$ [NC]
          RewriteRule ^ - [F,L]

          # ------------------------------------------------------------------------
          # Pobranie listy grup google usera i umieszczenie w headerze googlegroups, json w base64
          # ------------------------------------------------------------------------

          RewriteRule .* - [E=jsonheader:${gauthgroup:json#%{REMOTE_USER}}]
          RequestHeader set googlegroups %{jsonheader}e

          ##########################################################################
          ###########  GOOGLE GROUPS AUTHENTICATOR                               END
          ##########################################################################
        </Else>

        </Location>



        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
        SSLEngine on
        SSLCertificateFile  /etc/ssl/nginx/cert.pem
        SSLCertificateKeyFile /etc/ssl/nginx/key.pem
        <FilesMatch "\.(cgi|shtml|phtml|php)$">
                SSLOptions +StdEnvVars
        </FilesMatch>
        <Directory /usr/lib/cgi-bin>
                SSLOptions +StdEnvVars
        </Directory>

    </VirtualHost>

